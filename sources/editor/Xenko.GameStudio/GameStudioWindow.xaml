<Window x:Class="Xenko.GameStudio.GameStudioWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
        xmlns:strings="clr-namespace:Xenko.GameStudio.Resources.Strings"
        xmlns:stringsEd="clr-namespace:Xenko.Core.Assets.Editor.Resources.Strings;assembly=Xenko.Core.Assets.Editor"
        xmlns:gs="clr-namespace:Xenko.GameStudio"
        xmlns:xcad="http://schemas.xceed.com/wpf/xaml/avalondock"
        xmlns:xk="http://schemas.xenko.com/xaml/presentation"
        xmlns:viewModels="clr-namespace:Xenko.Core.Presentation.Quantum.ViewModels;assembly=Xenko.Core.Presentation.Quantum"
        xmlns:viewModels1="clr-namespace:Xenko.Core.Assets.Editor.Components.TemplateDescriptions.ViewModels;assembly=Xenko.Core.Assets.Editor"
        mc:Ignorable="d" d:DesignHeight="300" d:DesignWidth="300"
        Title="{Binding EditorTitle, RelativeSource={RelativeSource Self}}" Width="1280" Height="900" Style="{DynamicResource WindowChromeStyle}"
        PreviewMouseDown="EditorWindowPreviewMouseDown"
        d:DataContext="{d:DesignInstance gs:GameStudioViewModel}" x:Name="EditorWindow">
  <Window.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <ResourceDictionary Source="Theme.AvalonDock.xaml"/>
        <ResourceDictionary Source="/Xenko.Core.Assets.Editor;component/View/CommonResources.xaml" />
      </ResourceDictionary.MergedDictionaries>

      <DataTemplate x:Key="AvalonDock_GameStudio_TitleTemplate">
        <DockPanel LastChildFill="False">
          <TextBlock Margin="3 0" Text="{Binding Title}" TextTrimming="CharacterEllipsis"/>
          <TextBlock DockPanel.Dock="Left" HorizontalAlignment="Center" VerticalAlignment="Top"
                     Visibility="{Binding Path=Content.DataContext.IsDirty, Converter={xk:VisibleOrCollapsed}, FallbackValue={xk:Collapsed}}"
                     Text="*" TextAlignment="Center"/>
        </DockPanel>
      </DataTemplate>

      <!-- TODO: Migrate ImageDictionary from Editor to here -->
      <DrawingImage x:Key="ImageReloadProject">
        <DrawingImage.Drawing>
          <DrawingGroup>
            <DrawingGroup>
              <GeometryDrawing Brush="#00FFFFFF" Geometry="F1M16,16L0,16 0,0 16,0z" />
              <GeometryDrawing Brush="#FFF6F6F6" Geometry="F1M0,15L16,15 16,1 0,1z" />
              <GeometryDrawing Brush="#FF424242" Geometry="F1M14,13L2,13 2,5 14,5z M1,14L15,14 15,2 1,2z" />
              <GeometryDrawing Brush="#FFEFEFF0" Geometry="F1M14,13L2,13 2,5 14,5z" />
            </DrawingGroup>
            <DrawingGroup>
              <DrawingGroup.Transform>
                <TransformGroup>
                  <ScaleTransform ScaleX="0.3" ScaleY="0.3"/>
                  <SkewTransform/>
                  <RotateTransform/>
                  <TranslateTransform X="11" Y="10"/>
                </TransformGroup>
              </DrawingGroup.Transform>
              <GeometryDrawing Brush="#00FFFFFF" Geometry="F1M16,16L0,16 0,0 16,0z" />
              <GeometryDrawing Brush="#FFF6F6F6" Geometry="F1M16,8C16,12.411 12.411,16 8,16 3.589,16 0,12.411 0,8 0,6.597 0.384,5.212 1.088,4L0,4 0,0 8,0 8,8 4,8C4,10.206 5.794,12 8,12 10.206,12 12,10.206 12,8 12,6.656 11.331,5.41 10.21,4.666L9.377,4.112 11.592,0.78 12.425,1.333C14.663,2.822,16,5.314,16,8" />
              <GeometryDrawing Brush="#FF00529C" Geometry="F1M15,8C15,11.859 11.859,15 8,15 4.14,15 1,11.859 1,8 1,6.076 1.801,4.292 3.121,3L1,3 1,1 7,1 7,7 5,7 5,4.002C3.766,4.931 3,6.401 3,8 3,10.757 5.243,13 8,13 10.757,13 13,10.757 13,8 13,6.321 12.164,4.763 10.764,3.833L11.871,2.167C13.83,3.469,15,5.649,15,8" />
            </DrawingGroup>
          </DrawingGroup>
        </DrawingImage.Drawing>
      </DrawingImage>

      <ContextMenu x:Key="AssetContextMenu" d:DataContext="{d:DesignInstance xk:AssetCollectionViewModel}">
        <!-- Asset -->
        <MenuItem Header="{xk:Localize Asset, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Edit asset..., Context=Menu}" Command="{Binding Session.EditSelectedContentCommand}" Icon="{xk:Image {StaticResource ImageEditAsset}}" InputGestureText="{x:Static strings:KeyGestures.EditAsset}"/>
        <MenuItem Header="{Binding Session.SelectionIsRoot, Converter={xk:BoolToParam}, ConverterParameter={xk:Localize Don\'t include in build as root asset, Context=Menu},
                          FallbackValue={xk:Localize Include in build as root asset, Context=Menu}}" Command="{Binding Session.ToggleIsRootOnSelectedAssetCommand}"
                          Icon="{xk:Image {StaticResource ImageAssetIsRoot}}"/>
        <Separator Visibility="{Binding Session.ActiveAssetView.SingleSelectedAsset.AssetCommands.Count, Converter={xk:Chained {xk:NumericToBool}, {xk:VisibleOrCollapsed}}, FallbackValue={xk:Collapsed}}" />
        <!-- IsCheckable=True is a hack to prevent WPF from clearing the selected sub menu item -->
        <MenuItem ItemsSource="{Binding Session.ActiveAssetView.SingleSelectedAsset.AssetCommands}" IsCheckable="True"
                  Visibility="{Binding HasItems, RelativeSource={RelativeSource Self}, Converter={xk:VisibleOrCollapsed}, FallbackValue={xk:Collapsed}}">
          <MenuItem.ItemContainerStyle>
            <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}" d:DataContext="{d:DesignInstance xk:MenuCommandInfo}">
              <Setter Property="Command" Value="{Binding Command}" />
              <Setter Property="CommandParameter" Value="{Binding}" />
              <Setter Property="Header" Value="{Binding DisplayName}" />
              <Setter Property="Icon" Value="{Binding Icon}" />
              <Setter Property="IsEnabled" Value="{Binding Command.IsEnabled, Mode=OneWay}" />
              <Setter Property="ToolTip" Value="{Binding Tooltip}" />
              <Setter Property="InputGestureText" Value="{Binding Gesture}" />
            </Style>
          </MenuItem.ItemContainerStyle>
          <MenuItem.Template>
            <ControlTemplate>
              <StackPanel IsItemsHost="True" />
            </ControlTemplate>
          </MenuItem.Template>
        </MenuItem>
        <Separator/>
        <MenuItem Header="{xk:Localize Cut, Context=Menu}" Command="ApplicationCommands.Cut" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageCut}}"/>
        <MenuItem Header="{xk:Localize Copy, Context=Menu}" Command="ApplicationCommands.Copy" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageCopy}}"/>
        <MenuItem Header="{xk:Localize Copy with dependencies, Context=Menu}" Command="{Binding CopyAssetsRecursivelyCommand}" InputGestureText="{x:Static strings:KeyGestures.CopyAssetRecursively}" Icon="{xk:Image {StaticResource ImageCopyRecursively}}"/>
        <MenuItem Header="{xk:Localize Paste, Context=Menu}" Command="ApplicationCommands.Paste" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImagePaste}}"/>
        <MenuItem Header="{xk:Localize Delete, Context=Menu}" Command="ApplicationCommands.Delete" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageDelete}}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Copy asset URL, Context=Menu}" Command="{Binding CopyAssetUrlCommand}" />
        <MenuItem Header="{xk:Localize Rename, Context=Menu}" Command="xk:AssetViewUserControl.BeginEditCommand" Icon="{xk:Image {StaticResource ImageRename}}" InputGestureText="F2"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Create folder, Context=Menu}" Command="{Binding Session.NewDirectoryCommand}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageNewFolder}}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}" />
        <MenuItem Header="{xk:Localize Add asset..., Context=Menu}" Command="{Binding Session.ActiveAssetView.ShowAddAssetDialogCommand}" InputGestureText="{x:Static strings:KeyGestures.AddAsset}" Icon="{xk:Image {StaticResource ImageNewAsset}}" Visibility="{Binding Session.ActiveAssetView.ShowAddAssetDialogCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
        <MenuItem Header="{xk:Localize Update selected assets from their source, Context=Menu}" Command="{Binding Session.SourceTracker.UpdateSelectedAssetsFromSourceCommand}" InputGestureText="{x:Static stringsEd:KeyGestures.UpdateSelectedAssetsFromSource}" Icon="{xk:Image {StaticResource UpdateSelectedAssetsFromSource}}"/>
        <MenuItem Header="{xk:Localize Update all assets with modified source, Context=Menu}" Command="{Binding Session.SourceTracker.UpdateAllAssetsWithModifiedSourceCommand}" InputGestureText="{x:Static stringsEd:KeyGestures.UpdateAllAssetsWithModifiedSource}" Icon="{xk:Image {StaticResource UpdateAllAssetsWithModifiedSource}}"/>
        <!-- Explore -->
        <MenuItem Header="{xk:Localize Explore, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Open with text editor, Context=Menu}" Command="{Binding Session.OpenWithTextEditorCommand}" CommandParameter="{Binding SingleSelectedAsset}" Icon="{xk:Image {StaticResource ImageOpenWithTextEditor}}"/>
        <MenuItem Header="{xk:Localize Open asset file, Context=Menu}" Command="{Binding Session.OpenAssetFileCommand}" CommandParameter="{Binding SingleSelectedAsset}" Icon="{xk:Image {StaticResource ImageOpenAssetFile}}"/>
        <MenuItem Header="{xk:Localize Open source file, Context=Menu}" Command="{Binding Session.OpenSourceFileCommand}" CommandParameter="{Binding SingleSelectedAsset}" Icon="{xk:Image {StaticResource ImageOpenSourceFile}}"/>
        <MenuItem Header="{xk:Localize Show in Explorer, Context=Menu}" Command="{Binding Session.ExploreCommand}" CommandParameter="{Binding SelectedContent}" Icon="{xk:Image {StaticResource ImageExplore}}"/>
      </ContextMenu>

    </ResourceDictionary>
  </Window.Resources>

  <Window.InputBindings>
    <KeyBinding Command="{Binding Session.ActiveAssetView.CopyAssetsRecursivelyCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.CopyAssetRecursively}}" />
    <KeyBinding Command="{Binding Session.EditSelectedContentCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.EditAsset}}"/>
    <KeyBinding Command="{Binding Session.ActiveAssetView.ShowAddAssetDialogCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.AddAsset}}"/>
    <KeyBinding Command="{Binding Session.SourceTracker.UpdateSelectedAssetsFromSourceCommand}" Gesture="{xk:KeyGesture {x:Static stringsEd:KeyGestures.UpdateSelectedAssetsFromSource}}"/>
    <KeyBinding Command="{Binding Session.SourceTracker.UpdateAllAssetsWithModifiedSourceCommand}" Gesture="{xk:KeyGesture {x:Static stringsEd:KeyGestures.UpdateAllAssetsWithModifiedSource}}"/>
    <KeyBinding Command="{Binding Debugging.BuildProjectCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.BuildProject}}"/>
    <KeyBinding Command="{Binding Debugging.StartProjectCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.StartProject}}"/>
    <KeyBinding Command="{Binding Debugging.CancelBuildCommand}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.CancelBuild}}"/>
    <KeyBinding Command="{Binding OpenDebugWindowCommand, RelativeSource={RelativeSource AncestorType=Window}}" Gesture="{xk:KeyGesture {x:Static strings:KeyGestures.OpenDebugWindow}}"/>
  </Window.InputBindings>

  <i:Interaction.Behaviors>
    <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.New" Command="{Binding NewSessionCommand}"/>
    <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Open" Command="{Binding OpenSessionCommand}"/>
    <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Save" Command="{Binding Session.SaveSessionCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
    <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Undo" Command="{Binding Session.ActionHistory.UndoCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
    <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Redo" Command="{Binding Session.ActionHistory.RedoCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
  </i:Interaction.Behaviors>

  <Grid>
    <Grid.RowDefinitions>
      <!-- MENU ROW DEFINITION-->
      <RowDefinition Height="Auto"/>
      <!-- DOCUMENT ROW DEFINITION-->
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- MENU ROW -->
    <Menu IsHitTestVisible="True" Grid.Row="0" FontSize="12">
      <!-- File Menu -->
      <MenuItem Header="{xk:Localize File, Context=Menu}">
        <MenuItem Header="{xk:Localize New, Context=Menu}" Command="ApplicationCommands.New" Icon="{xk:Image {StaticResource ImageNewSolution}}"/>
        <MenuItem Header="{xk:Localize Open, Context=Menu}" Command="ApplicationCommands.Open" Icon="{xk:Image {StaticResource ImageOpen}}"/>
        <MenuItem Header="{xk:Localize Open recent, Context=Menu}" Icon="{xk:Image {StaticResource ImageOpen}}" IsEnabled="{Binding MRU.MostRecentlyUsedFiles.Count, Converter={xk:NumericToBool}}">
          <!-- IsCheckable=True is a hack to prevent WPF from clearing the selected sub menu item -->
          <MenuItem ItemsSource="{Binding RecentFiles}" IsCheckable="True">
            <MenuItem.ItemTemplate>
              <DataTemplate>
                <Grid HorizontalAlignment="Stretch" ToolTip="{Binding FilePath, Converter={xk:UFileToString}, Mode=OneWay}">
                  <Grid.ColumnDefinitions >
                    <ColumnDefinition Width="30"/>
                    <ColumnDefinition MaxWidth="320"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Grid.Column="0" Text="{Binding Version}" FontWeight="Bold" />
                  <TextBlock Grid.Column="1"
                             Text="{xk:MultiBinding {Binding FilePath, Converter={xk:UFileToString}, Mode=OneWay}, {Binding RelativeSource={RelativeSource Self}},
                                                      Converter={xk:TrimString MaxWidth=320, TextTrimming=WordEllipsis, TrimmingSource=Middle, WordSeparators=/\\}}"/>
                </Grid>
              </DataTemplate>
            </MenuItem.ItemTemplate>
            <MenuItem.ItemContainerStyle>
              <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
                <Setter Property="Command" Value="{Binding DataContext.OpenSessionCommand, RelativeSource={RelativeSource AncestorType=Menu}}"/>
                <Setter Property="CommandParameter" Value="{Binding FilePath}"/>
              </Style>
            </MenuItem.ItemContainerStyle>
            <MenuItem.Template>
              <ControlTemplate>
                <StackPanel IsItemsHost="True"/>
              </ControlTemplate>
            </MenuItem.Template>
          </MenuItem>
          <Separator/>
          <MenuItem Header="{xk:Localize Clear list, Context=Menu}" Command="{Binding ClearMRUCommand}" Icon="{xk:Image {StaticResource ImageDelete}}"/>
        </MenuItem>
        <MenuItem Header="{xk:Localize Save, Context=Menu}" Command="ApplicationCommands.Save" Icon="{xk:Image {StaticResource ImageSave}}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Reload project, Context=Menu}" Command="{Binding ReloadSessionCommand}" Icon="{xk:Image {StaticResource ImageReloadProject}}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Quit, Context=Menu}">
          <i:Interaction.Behaviors>
            <xk:MenuItemCloseWindowBehavior/>
          </i:Interaction.Behaviors>
        </MenuItem>
      </MenuItem>
      <!-- Edit Menu -->
      <MenuItem Header="{xk:Localize Edit, Context=Menu}">
        <MenuItem Header="{xk:Localize Undo, Context=Menu}" Command="ApplicationCommands.Undo" Icon="{xk:Image {StaticResource ImageUndo}}"/>
        <MenuItem Header="{xk:Localize Redo, Context=Menu}" Command="ApplicationCommands.Redo" Icon="{xk:Image {StaticResource ImageRedo}}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Cut, Context=Menu}" Command="ApplicationCommands.Cut" Icon="{xk:Image {StaticResource ImageCut}}" />
        <MenuItem Header="{xk:Localize Copy, Context=Menu}" Command="ApplicationCommands.Copy" Icon="{xk:Image {StaticResource ImageCopy}}" />
        <MenuItem Header="{xk:Localize Paste, Context=Menu}" Command="ApplicationCommands.Paste" Icon="{xk:Image {StaticResource ImagePaste}}" />
        <MenuItem Header="{xk:Localize Delete, Context=Menu}" Command="ApplicationCommands.Delete" Icon="{xk:Image {StaticResource ImageDelete}}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Settings, Context=Menu}" Command="{Binding OpenSettingsWindowCommand}" Icon="{xk:Image {StaticResource ImageSettings}}"/>
      </MenuItem>
      <!-- Project Menu -->
      <MenuItem Header="{xk:Localize Project, Context=Menu}" IsEnabled="{Binding Session, Converter={xk:ObjectToBool}}">
        <MenuItem Header="{xk:Localize Build project, Context=Menu}" Command="{Binding Debugging.BuildProjectCommand}" Icon="{xk:Image {StaticResource ImageBuildProject}}" InputGestureText="{x:Static strings:KeyGestures.BuildProject}"/>
        <MenuItem Header="{xk:Localize Start project, Context=Menu}" Command="{Binding Debugging.StartProjectCommand}" Icon="{xk:Image {StaticResource ImageStartProject}}" InputGestureText="{x:Static strings:KeyGestures.StartProject}"/>
        <!-- Disable live-scripting commands until it is working -->
        <MenuItem Header="{xk:Localize Start live-scripting, Context=Menu}" Command="{Binding Debugging.LivePlayProjectCommand}" Icon="{xk:Image {StaticResource ImageLiveScripting}}" Visibility="Collapsed"/>
        <MenuItem Header="{xk:Localize Cancel build, Context=Menu}" Command="{Binding Debugging.CancelBuildCommand}" Icon="{xk:Image {StaticResource ImageStopBuild}}" InputGestureText="{x:Static strings:KeyGestures.CancelBuild}"/>
        <MenuItem Header="{xk:Localize Folder, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Create folder, Context=Menu}" Command="{Binding Session.NewDirectoryCommand}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageNewFolder}}"/>

        <MenuItem Header="{xk:Localize Package, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Update package, Context=Menu}" ItemsSource="{Binding Session.UpdatePackageViewModel.Templates}" Icon="{xk:Image {StaticResource ImageAddNewProject}}" Visibility="{Binding Session.IsUpdatePackageEnabled, Converter={xk:VisibleOrCollapsed}}">
          <MenuItem.ItemContainerStyle>
            <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}" d:DataContext="{d:DesignInstance viewModels1:TemplateDescriptionViewModel}">
              <Setter Property="Command" Value="{Binding UpdatePackageCommand}"/>
            </Style>
          </MenuItem.ItemContainerStyle>
          <MenuItem.ItemTemplate>
            <DataTemplate DataType="viewModels1:TemplateDescriptionViewModel">
              <DockPanel Width="384">
                <Image Source="{Binding Icon}" DockPanel.Dock="Left" Width="48" Height="48" Margin="2"/>
                <DockPanel Margin="18,0">
                  <TextBlock DockPanel.Dock="Top" FontSize="16" Text="{Binding Name}"/>
                  <TextBlock Text="{Binding Description}" TextWrapping="Wrap" TextTrimming="WordEllipsis"/>
                </DockPanel>
              </DockPanel>
            </DataTemplate>
          </MenuItem.ItemTemplate>
        </MenuItem>
        <MenuItem Header="{xk:Localize Add dependency..., Context=Menu}" Command="{Binding Session.AddDependencyCommand}" Icon="{xk:Image {StaticResource ImageAddDependency}}"/>
        <MenuItem Header="{xk:Localize Set as current project, Context=Menu}" Command="{Binding Session.SetCurrentProjectCommand}" CommandParameter="{Binding}" Icon="{xk:Image {StaticResource ImageStartupProject}}"/>
        <MenuItem Header="{xk:Localize Package properties, Context=Menu}" Command="{Binding Session.ActivatePackagePropertiesCommand}" Icon="{xk:Image {StaticResource ImagePackageProperties}}"/>

        <MenuItem Header="{xk:Localize Solution, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize New project..., Context=Menu}" Command="{Binding Session.NewProjectCommand}" Icon="{xk:Image {StaticResource ImageAddNewPackage}}"/>
        <MenuItem Header="{xk:Localize Add existing project..., Context=Menu}" Command="{Binding Session.AddExistingProjectCommand}" Icon="{xk:Image {StaticResource ImageAddExistingProject}}"/>
        <MenuItem Header="{xk:Localize Open in IDE, Context=Menu}" Command="{Binding Session.OpenInIDECommand}" Icon="{xk:Image {StaticResource ImageVisualStudio}}"/>
        <MenuItem Header="{xk:Localize Reload game assemblies, Context=Menu}" Command="{Binding Debugging.ReloadAssembliesCommand}" Icon="{xk:Image {StaticResource ImageReloadAssemblies}}"/>

        <MenuItem Header="{xk:Localize Actions, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Delete, Context=Menu}" Command="{Binding Session.DeleteSelectedSolutionItemsCommand}" Icon="{xk:Image {StaticResource ImageDelete}}"/>
        <MenuItem Header="{xk:Localize Rename, Context=Menu}" Command="{Binding Session.RenameDirectoryOrPackageCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageRename}}" InputGestureText="F2"/>

        <MenuItem Header="{xk:Localize Asset, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
        <MenuItem Header="{xk:Localize Add asset..., Context=Menu}" Command="{Binding Session.ActiveAssetView.ShowAddAssetDialogCommand}" InputGestureText="{x:Static strings:KeyGestures.AddAsset}" Icon="{xk:Image {StaticResource ImageNewAsset}}"/>
        <MenuItem Header="{xk:Localize Update selected assets from their source, Context=Menu}" Command="{Binding Session.SourceTracker.UpdateSelectedAssetsFromSourceCommand}" InputGestureText="{x:Static stringsEd:KeyGestures.UpdateSelectedAssetsFromSource}" Icon="{xk:Image {StaticResource UpdateSelectedAssetsFromSource}}"/>
        <MenuItem Header="{xk:Localize Update all assets with modified source, Context=Menu}" Command="{Binding Session.SourceTracker.UpdateAllAssetsWithModifiedSourceCommand}" InputGestureText="{x:Static stringsEd:KeyGestures.UpdateAllAssetsWithModifiedSource}" Icon="{xk:Image {StaticResource UpdateAllAssetsWithModifiedSource}}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
        <MenuItem Header="{xk:Localize Explore, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{Binding Session.ExploreCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
        <MenuItem Header="{xk:Localize Show in Explorer, Context=Menu}" Command="{Binding Session.ExploreCommand}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageExplore}}" Visibility="{Binding Session.ExploreCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
      </MenuItem>
      <!-- View Menu -->
      <MenuItem Header="{xk:Localize View, Context=Menu}" IsEnabled="{Binding Session, Converter={xk:ObjectToBool}}">
        <MenuItem Header="{xk:Localize Solution explorer, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.SessionExplorerPanelVisible, Mode=TwoWay}"/>
        <MenuItem Header="{xk:Localize Asset view, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.AssetViewPanelVisible, Mode=TwoWay}"/>
        <MenuItem Header="{xk:Localize References, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.ReferencesPanelVisible, Mode=TwoWay}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Asset preview, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.AssetPreviewPanelVisible, Mode=TwoWay}"/>

        <Separator/>
        <MenuItem Header="{xk:Localize Property grid, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.PropertyGridPanelVisible, Mode=TwoWay}"/>
        <MenuItem Header="{xk:Localize Edit history, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.ActionHistoryPanelVisible, Mode=TwoWay}"/>

        <Separator/>
        <MenuItem Header="{xk:Localize Asset errors, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.AssetLogPanelVisible, Mode=TwoWay}"/>
        <MenuItem Header="{xk:Localize Output, Context=Menu}" IsCheckable="True" IsChecked="{Binding Panels.BuildLogPanelVisible, Mode=TwoWay}"/>

      </MenuItem>
      <!-- Help Menu -->
      <MenuItem Header="{xk:Localize Help, Context=Menu}">
        <MenuItem Header="{xk:Localize Online documentation, Context=Menu}" Command="{Binding OpenWebPageCommand}" CommandParameter="{x:Static gs:XenkoGameStudio.DocumentationUrl}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Questions and answers, Context=Menu}" Command="{Binding OpenWebPageCommand}" CommandParameter="{x:Static gs:XenkoGameStudio.AnswersUrl}"/>
        <MenuItem Header="{xk:Localize Report an issue..., Context=Menu}" Command="{Binding OpenWebPageCommand}" CommandParameter="{x:Static gs:XenkoGameStudio.ReportIssueUrl}"/>
        <MenuItem Header="{xk:Localize Community forums, Context=Menu}" Command="{Binding OpenWebPageCommand}" CommandParameter="{x:Static gs:XenkoGameStudio.ForumsUrl}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize Show debug window, Context=Menu}" Command="{Binding OpenDebugWindowCommand, RelativeSource={RelativeSource AncestorType=Window}}" InputGestureText="{x:Static strings:KeyGestures.OpenDebugWindow}"/>
        <Separator/>
        <MenuItem Header="{xk:Localize About..., Context=Menu}" Command="{Binding OpenAboutPageCommand}"/>
      </MenuItem>
      <!-- Debug Menu -->
      <MenuItem Header="Debug" Visibility="{Binding IsTestMenuVisible, ElementName=EditorWindow, Converter={xk:VisibleOrCollapsed}}">
        <MenuItem Header="Create test asset" Command="{Binding CreateTestAssetCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        <MenuItem Header="Create unit test asset" Command="{Binding CreateUnitTestAssetCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        <Separator/>
        <MenuItem Header="Break with debugger" Command="{Binding BreakDebuggerCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
      </MenuItem>
    </Menu>

    <!-- DOCUMENT ROW -->
    <Grid Grid.Row="1">
      <Grid.RowDefinitions>
        <!-- TOOLBAR ROW DEFINITION-->
        <RowDefinition Height="Auto"/>
        <!-- DOCKING ROW DEFINITION -->
        <RowDefinition Height="*"/>
        <!-- STATUS BAR ROW DEFINITION-->
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- TOOLBAR ROW -->
      <ToolBarTray Grid.Row="0" Visibility="{Binding Session, Converter={xk:Chained {xk:ObjectToBool}, {xk:VisibleOrCollapsed}}}">
        <ToolBar>
          <Button Command="ApplicationCommands.New"
                  ToolTip="{xk:Localize Create a project, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageNewSolution}" />
          </Button>
          <Button Command="ApplicationCommands.Open" Margin="2,0,0,0"
                  ToolTip="{xk:Localize Open an existing project, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageOpen}" />
          </Button>
          <Menu Background="Transparent" Margin="0"
                ToolTip="{xk:Localize Open recent, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True"
                ToolTipService.IsEnabled="{Binding ElementName=MRUMenu, Path=IsSubmenuOpen, Converter={xk:InvertBool}}">
            <MenuItem x:Name="MRUMenu" ItemsSource="{Binding RecentFiles}" Style="{StaticResource ToolBarDropDownMenuItemStyle}">
              <MenuItem.ItemTemplate>
                <DataTemplate>
                  <Grid HorizontalAlignment="Stretch" ToolTip="{Binding FilePath, Converter={xk:UFileToString}, Mode=OneWay}">
                    <Grid.ColumnDefinitions >
                      <ColumnDefinition Width="30"/>
                      <ColumnDefinition MaxWidth="320"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding Version}" FontWeight="Bold" />
                    <TextBlock Grid.Column="1"
                               Text="{xk:MultiBinding {Binding FilePath, Converter={xk:UFileToString}, Mode=OneWay}, {Binding RelativeSource={RelativeSource Self}},
                                                        Converter={xk:TrimString MaxWidth=320, TextTrimming=WordEllipsis, TrimmingSource=Middle, WordSeparators=/\\}}"/>
                  </Grid>
                </DataTemplate>
              </MenuItem.ItemTemplate>
              <MenuItem.ItemContainerStyle>
                <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
                  <Setter Property="Command" Value="{Binding DataContext.OpenSessionCommand, RelativeSource={RelativeSource AncestorType=Menu}}"/>
                  <Setter Property="CommandParameter" Value="{Binding FilePath}"/>
                </Style>
              </MenuItem.ItemContainerStyle>
            </MenuItem>
          </Menu>
          <Button Command="ApplicationCommands.Save"
                  ToolTip="{xk:Localize Save the project and all its documents, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageSave}" />
          </Button>
          <Separator/>
          <Button Command="{Binding ReloadSessionCommand}"
                  ToolTip="{xk:Localize Reload current project (ask to save), Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageReloadProject}" />
          </Button>
          <Separator/>
          <Button Command="ApplicationCommands.Undo"
                  ToolTip="{xk:Localize Undo last action, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageUndo}" />
          </Button>
          <Button Command="ApplicationCommands.Redo"
                  ToolTip="{xk:Localize Redo last cancelled action, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageRedo}" />
          </Button>
        </ToolBar>
        <ToolBar>
          <Button Command="{Binding Session.OpenInIDECommand}" Margin="2,0,0,0"
                  ToolTip="{xk:Localize Open in IDE, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageVisualStudio}" Width="16" Height="16" />
          </Button>
          <Menu Background="Transparent"
                ToolTip="{xk:Localize Open with..., Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <MenuItem ItemsSource="{Binding AvailableIDEs}" Style="{StaticResource ToolBarDropDownMenuItemStyle}">
              <MenuItem.ItemContainerStyle>
                <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
                  <Setter Property="Command" Value="{Binding DataContext.Session.OpenInIDECommand, RelativeSource={RelativeSource AncestorType=Menu}}"/>
                  <Setter Property="CommandParameter" Value="{Binding}"/>
                </Style>
              </MenuItem.ItemContainerStyle>
            </MenuItem>
          </Menu>
          <Button Command="{Binding Debugging.ReloadAssembliesCommand}"
                  ToolTip="{xk:Localize Reload game assemblies and update scripts, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Grid>
              <Image Source="{StaticResource ImageReloadAssemblies}"/>
              <Rectangle Fill="White" Visibility="{Binding Debugging.ReloadAssembliesCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}">
                <Rectangle.OpacityMask>
                  <ImageBrush ImageSource="{StaticResource ImageReloadAssemblies}"/>
                </Rectangle.OpacityMask>
                <Rectangle.Triggers>
                  <EventTrigger RoutedEvent="Window.Loaded">
                    <BeginStoryboard>
                      <Storyboard RepeatBehavior="Forever">
                        <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5" BeginTime="0:0:0" AutoReverse="True"/>
                      </Storyboard>
                    </BeginStoryboard>
                  </EventTrigger>
                </Rectangle.Triggers>
              </Rectangle>
            </Grid>
          </Button>
          <Separator/>
          <Button Command="{Binding Debugging.BuildProjectCommand}"
                  ToolTip="{xk:ToolTip {xk:Localize Build the project, Context=ToolTip}, {x:Static strings:KeyGestures.BuildProject}}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageBuildProject}"/>
          </Button>
          <Button Command="{Binding Debugging.StartProjectCommand}"
                  ToolTip="{xk:ToolTip {xk:Localize Build the project and start the game, Context=ToolTip}, {x:Static strings:KeyGestures.StartProject}}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageStartProject}"/>
          </Button>
          <!-- Live Scripting -->
          <!-- FIXME live scripting is disabled (XK-4309) -->
          <Button Command="{Binding Debugging.LivePlayProjectCommand}"
                  ToolTip="{xk:Localize Start project in live-scripting mode, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True"
                  Visibility="Collapsed">
            <Image Source="{StaticResource ImageLiveScripting}"/>
          </Button>
          <Button Command="{Binding Debugging.CancelBuildCommand}"
                  ToolTip="{xk:ToolTip {xk:Localize Cancel the current build, Context=ToolTip}, {x:Static strings:KeyGestures.CancelBuild}}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
            <Image Source="{StaticResource ImageStopBuild}"/>
          </Button>
        </ToolBar>
      </ToolBarTray>

      <!-- DOCKING ROW -->
      <xcad:DockingManager x:Name="Docking" Grid.Row="1" Visibility="{Binding Session, Converter={xk:Chained {xk:ObjectToBool}, {xk:VisibleOrCollapsed}}}"
                           AllowMixedOrientation="True"
                           DocumentHeaderTemplate="{StaticResource AvalonDock_GameStudio_TitleTemplate}" DocumentTitleTemplate="{StaticResource AvalonDock_GameStudio_TitleTemplate}" AnchorableTitleTemplate="{StaticResource AvalonDock_GameStudio_TitleTemplate}">
        <xcad:LayoutRoot>
          <xcad:LayoutPanel Orientation="Horizontal">
            <xcad:LayoutPanel Orientation="Vertical">
              <xcad:LayoutPanel Orientation="Horizontal">
                <xcad:LayoutAnchorablePane DockWidth="300">
                  <!-- SOLUTION EXPLORER -->
                  <xcad:LayoutAnchorable AutoHideMinWidth="300" ContentId="SolutionExplorer" Title="{Binding Source={xk:Localize Solution explorer, Context=View}}"
                                         gs:AvalonDockHelper.IsVisible="{Binding Panels.SessionExplorerPanelVisible, Mode=TwoWay,
                                         Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                    <DockPanel>
                      <ToolBarTray DockPanel.Dock="Top">
                        <ToolBar>
                          <Button Command="{Binding Session.NewProjectCommand}"
                            ToolTip="{xk:Localize Create a project..., Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageAddNewPackage}" />
                          </Button>
                          <Button Command="{Binding Session.NewDirectoryCommand}" CommandParameter="{Binding SelectedItems, ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Create a folder, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageNewFolder}" />
                          </Button>
                          <Separator/>
                          <Button Command="{Binding Session.ActivatePackagePropertiesCommand}"
                            ToolTip="{xk:Localize Display the properties of the selected package in the property grid, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImagePackageProperties}" />
                          </Button>
                          <Button Command="{Binding Session.RenameDirectoryOrPackageCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}}" CommandParameter="{Binding SelectedItems, ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Rename the selected folder or package, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageRename}" />
                          </Button>
                          <Button Command="{Binding Session.DeleteSelectedSolutionItemsCommand}"
                            ToolTip="{xk:Localize Delete the selected items, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageDelete}" />
                          </Button>
                          <Separator/>
                          <Button Command="{x:Static xk:SessionExplorerHelper.ExpandAssetFolders}" CommandTarget="{Binding ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Expand all asset folders, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageExpandAssetFolders}" />
                          </Button>
                          <Button Command="{x:Static xk:SessionExplorerHelper.ExpandAllFolders}" CommandTarget="{Binding ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Expand all, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageExpandAllFolders}" />
                          </Button>
                          <Button Command="{x:Static xk:SessionExplorerHelper.CollapseAllFolders}" CommandTarget="{Binding ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Collapse all, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageCollapseAllFolders}" />
                          </Button>
                          <Separator/>
                          <Button Command="{Binding Session.ExploreCommand}" CommandParameter="{Binding SelectedItems, ElementName=DirectoryTreeView}"
                            ToolTip="{xk:Localize Show in Explorer, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Status}" ToolTipService.ShowOnDisabled="True">
                            <Image Source="{StaticResource ImageExplore}" />
                          </Button>
                        </ToolBar>
                      </ToolBarTray>
                      <!-- TODO: SearchText -->
                      <xk:TreeView x:Name="DirectoryTreeView" ItemsSource="{Binding Session.PackageCategories.Values}" AllowDrop="True" IsVirtualizing="False">
                        <xk:TreeView.Resources>
                          <ContextMenu x:Key="ContextMenu">
                            <MenuItem Header="{xk:Localize Folder, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Create folder, Context=Menu}" Command="{Binding Session.NewDirectoryCommand}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageNewFolder}}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>

                            <MenuItem Header="{xk:Localize Package, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{xk:MultiBinding {Binding Session.IsUpdatePackageEnabled}, {Binding Session.AddExistingProjectCommand.IsEnabled}, {Binding Session.AddDependencyCommand.IsEnabled}, {Binding Session.SetCurrentProjectCommand.IsEnabled}, Converter={xk:MultiChained {xk:OrMultiConverter}, {xk:VisibleOrCollapsed}}}"/>
                            <MenuItem Header="{xk:Localize Update package, Context=Menu}" ItemsSource="{Binding Session.UpdatePackageViewModel.Templates}" Icon="{xk:Image {StaticResource ImageAddNewProject}}" Visibility="{Binding Session.IsUpdatePackageEnabled, Converter={xk:VisibleOrCollapsed}}">
                              <MenuItem.ItemContainerStyle>
                                <Style TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}" d:DataContext="{d:DesignInstance viewModels1:TemplateDescriptionViewModel}">
                                  <Setter Property="Command" Value="{Binding UpdatePackageCommand}"/>
                                </Style>
                              </MenuItem.ItemContainerStyle>
                              <MenuItem.ItemTemplate>
                                <DataTemplate DataType="viewModels1:TemplateDescriptionViewModel">
                                  <DockPanel Width="384">
                                    <Image Source="{Binding Icon}" DockPanel.Dock="Left" Width="48" Height="48" Margin="2"/>
                                    <DockPanel Margin="18,0">
                                      <TextBlock DockPanel.Dock="Top" FontSize="16" Text="{Binding Name}"/>
                                      <TextBlock Text="{Binding Description}" TextWrapping="Wrap" TextTrimming="WordEllipsis"/>
                                    </DockPanel>
                                  </DockPanel>
                                </DataTemplate>
                              </MenuItem.ItemTemplate>
                            </MenuItem>
                            <MenuItem Header="{xk:Localize Add dependency..., Context=Menu}" Command="{Binding Session.AddDependencyCommand}" Icon="{xk:Image {StaticResource ImageAddDependency}}" Visibility="{Binding Session.AddDependencyCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Set as current project, Context=Menu}" Command="{Binding Session.SetCurrentProjectCommand}" CommandParameter="{Binding}" Icon="{xk:Image {StaticResource ImageStartupProject}}" Visibility="{Binding Session.SetCurrentProjectCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Package properties, Context=Menu}" Command="{Binding Session.ActivatePackagePropertiesCommand}" Icon="{xk:Image {StaticResource ImagePackageProperties}}" Visibility="{Binding Session.ActivatePackagePropertiesCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>

                            <MenuItem Header="{xk:Localize Solution, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{xk:MultiBinding {Binding Session.NewPackageCommand.IsEnabled}, {Binding Session.AddExistingPackageCommand.IsEnabled}, {Binding Session.OpenInIDECommand.IsEnabled}, Converter={xk:MultiChained {xk:OrMultiConverter}, {xk:VisibleOrCollapsed}}}"/>
                            <MenuItem Header="{xk:Localize New project..., Context=Menu}" Command="{Binding Session.NewProjectCommand}" Icon="{xk:Image {StaticResource ImageAddNewPackage}}" Visibility="{Binding Session.NewProjectCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Add existing project..., Context=Menu}" Command="{Binding Session.AddExistingProjectCommand}" Icon="{xk:Image {StaticResource ImageAddExistingProject}}" Visibility="{Binding Session.AddExistingProjectCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Open in IDE, Context=Menu}" Command="{Binding Session.OpenInIDECommand}" Icon="{xk:Image {StaticResource ImageVisualStudio}}" Visibility="{Binding Session.OpenInIDECommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>

                            <MenuItem Header="{xk:Localize Actions, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}"/>
                            <MenuItem Header="{xk:Localize Cut, Context=Menu}" Command="ApplicationCommands.Cut" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageCut}}"/>
                            <MenuItem Header="{xk:Localize Copy, Context=Menu}" Command="ApplicationCommands.Copy" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageCopy}}"/>
                            <MenuItem Header="{xk:Localize Paste, Context=Menu}" Command="ApplicationCommands.Paste" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImagePaste}}"/>
                            <MenuItem Header="{xk:Localize Delete, Context=Menu}" Command="ApplicationCommands.Delete" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type ContextMenu}}}" Icon="{xk:Image {StaticResource ImageDelete}}"/>
                            <MenuItem Header="{xk:Localize Rename, Context=Menu}" Command="{Binding Session.RenameDirectoryOrPackageCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}}" CommandParameter="{Binding Session.ActiveAssetView.SelectedLocations}" Icon="{xk:Image {StaticResource ImageRename}}" Visibility="{Binding Session.RenameDirectoryOrPackageCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}" InputGestureText="F2"/>

                            <MenuItem Header="{xk:Localize Asset, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Add asset..., Context=Menu}" Command="{Binding Session.ActiveAssetView.ShowAddAssetDialogCommand}" InputGestureText="{x:Static strings:KeyGestures.AddAsset}" Icon="{xk:Image {StaticResource ImageNewAsset}}" Visibility="{Binding Session.NewDirectoryCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>

                            <MenuItem Header="{xk:Localize Explore, Context=Menu}" Style="{StaticResource MenuGroupSeparatorStyle}" Visibility="{Binding Session.ExploreCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>
                            <MenuItem Header="{xk:Localize Show in Explorer, Context=Menu}" Command="{Binding Session.ExploreCommand}" CommandParameter="{Binding}" Icon="{xk:Image {StaticResource ImageExplore}}" Visibility="{Binding Session.ExploreCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}}"/>

                          </ContextMenu>
                        </xk:TreeView.Resources>
                        <i:Interaction.Behaviors>
                          <xk:DragOverAutoScrollBehavior/>
                          <xk:TreeViewAutoExpandBehavior/>
                          <xk:TreeViewDragDropBehavior DragVisualTemplate="{StaticResource DragVisualTemplate}"/>
                          <xk:TreeViewBindableSelectedItemsBehavior SelectedItems="{Binding Session.ActiveAssetView.SelectedLocations}"/>
                          <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Cut" Command="{Binding Session.ActiveAssetView.CutLocationsCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                          <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Copy" Command="{Binding Session.ActiveAssetView.CopyLocationsCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                          <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Paste" Command="{Binding Session.ActiveAssetView.PasteCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                          <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Delete" Command="{Binding Session.DeleteSelectedSolutionItemsCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                        </i:Interaction.Behaviors>
                        <xk:TreeView.ItemContainerStyle>
                          <Style TargetType="{x:Type xk:TreeViewItem}" BasedOn="{StaticResource {x:Type xk:TreeViewItem}}">
                            <Setter Property="IsExpanded" Value="{Binding Mode=OneTime, Converter={xk:AssetToExpandedAtInitialization}}"/>
                            <Setter Property="IsEditable" Value="{Binding IsEditable, Mode=OneTime}" d:DataContext="{d:DesignInstance xk:IIsEditableViewModel}"/>
                            <Setter Property="IsEditing" Value="{Binding IsEditing, Mode=TwoWay}" d:DataContext="{d:DesignInstance xk:IIsEditableViewModel}"/>
                            <Setter Property="ContextMenu" Value="{StaticResource ContextMenu}"/>
                            <Setter Property="TemplateSelectorEdit" Value="{StaticResource SolutionTreeViewEditTemplate}"/>
                            <Setter Property="xk:Interaction.Behaviors">
                              <Setter.Value>
                                <xk:BehaviorCollection>
                                  <xk:TreeViewStopEditOnLostFocusBehavior/>
                                </xk:BehaviorCollection>
                              </Setter.Value>
                            </Setter>
                          </Style>
                        </xk:TreeView.ItemContainerStyle>
                        <xk:TreeView.ItemTemplate>
                          <HierarchicalDataTemplate ItemsSource="{Binding Content}" ItemTemplateSelector="{StaticResource SolutionTreeViewTemplate}">
                            <TextBlock Text="{Binding Name}"/>
                          </HierarchicalDataTemplate>
                        </xk:TreeView.ItemTemplate>
                      </xk:TreeView>
                    </DockPanel>
                  </xcad:LayoutAnchorable>
                </xcad:LayoutAnchorablePane>
                <xcad:LayoutDocumentPane>
                  <!-- ASSET VIEW -->
                  <xcad:LayoutAnchorable AutoHideMinWidth="300" ContentId="AssetView" Title="{Binding Source={xk:Localize Asset view, Context=View}}"
                                           gs:AvalonDockHelper.IsVisible="{Binding Panels.AssetViewPanelVisible, Mode=TwoWay,
                                           Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                    <xk:AssetViewUserControl AssetCollection="{Binding Session.ActiveAssetView}" AssetContextMenu="{StaticResource AssetContextMenu}"
                                           AssetDoubleClick="{Binding Session.EditSelectedContentCommand}">
                      <i:Interaction.Behaviors>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Cut" Command="{Binding Session.ActiveAssetView.CutContentCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Copy" Command="{Binding Session.ActiveAssetView.CopyContentCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Paste" Command="{Binding Session.ActiveAssetView.PasteCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Delete" Command="{Binding Session.ActiveAssetView.DeleteContentCommand}"/>
                        <gs:ActivateParentPaneOnGotFocusBehavior/>
                      </i:Interaction.Behaviors>
                    </xk:AssetViewUserControl>
                    <i:Interaction.Behaviors>
                      <gs:LayoutAnchorableActivateOnLocationChangedBehavior Collection="{Binding Session.ActiveAssetView.SelectedLocations}" />
                    </i:Interaction.Behaviors>
                  </xcad:LayoutAnchorable>
                </xcad:LayoutDocumentPane>
              </xcad:LayoutPanel>
              <xcad:LayoutAnchorablePane DockHeight="200">
                <!-- REFERENCES -->
                <xcad:LayoutAnchorable AutoHideMinHeight="200" ContentId="References" Title="{Binding Source={xk:Localize References, Context=View}}"
                                       gs:AvalonDockHelper.IsVisible="{Binding Panels.ReferencesPanelVisible, Mode=TwoWay,
                                       Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                  <DockPanel LastChildFill="True" x:Name="RefViewDockPanel">
                    <!-- stats -->
                    <Border DockPanel.Dock="Bottom" Padding="10,5">
                      <TextBlock Text="{Binding Session.References.TypeCountersAsText}" TextTrimming="CharacterEllipsis" TextWrapping="NoWrap">
                        <TextBlock.ToolTip>
                          <TextBlock Text="{Binding Session.References.TypeCountersAsText}" TextTrimming="None" TextWrapping="Wrap" />
                        </TextBlock.ToolTip>
                      </TextBlock>
                    </Border>
                    <!-- view -->
                    <xk:AssetViewUserControl AssetCollection="{Binding Session.References.DisplayedReferences}" AssetContextMenu="{StaticResource AssetContextMenu}" GiveFocusOnSelectionChange="False"
                                               CanEditAssets="False" CanAddAssets="False" CanDeleteAssets="False" CanRecursivelyDisplayAssets="False" TileThumbnailSize="64" AssetDoubleClick="{Binding Session.ActiveAssetView.SelectAssetCommand}"
                                               BorderThickness="0">
                      <xk:AssetViewUserControl.PrimaryToolBarItems>
                        <ToggleButton IsChecked="{Binding Session.References.ShowReferencers, Converter={xk:InvertBool}}" Content="{xk:Localize References}" MinWidth="80"/>
                        <ToggleButton IsChecked="{Binding Session.References.ShowReferencers}" Content="{xk:Localize Referenced by}" MinWidth="80"/>
                      </xk:AssetViewUserControl.PrimaryToolBarItems>
                      <i:Interaction.Behaviors>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Cut" Command="{Binding Session.References.DisplayedReferences.CutContentCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                        <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Copy" Command="{Binding Session.References.DisplayedReferences.CopyContentCommand, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                      </i:Interaction.Behaviors>
                    </xk:AssetViewUserControl>
                  </DockPanel>
                </xcad:LayoutAnchorable>
                <!-- ASSET LOG -->
                <xcad:LayoutAnchorable AutoHideMinHeight="200" ContentId="AssetLog"
                                       Title="{xk:Localize Asset error ({0}), Plural=Asset errors ({0}), Count={Binding Session.AssetLog.ErrorCount, Source={x:Static gs:GameStudioViewModel.GameStudio}}, IsStringFormat=True, Context=View}"
                                       gs:AvalonDockHelper.IsVisible="{Binding Panels.AssetLogPanelVisible, Mode=TwoWay,
                                       Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                  <xk:GridLogViewer LogMessages="{Binding Session.AssetLog.FilteredMessages}" Session="{Binding Session}" ShowDebugMessages="False" ShowVerboseMessages="False" ShowInfoMessages="False"/>
                </xcad:LayoutAnchorable>
                <!-- BUILD LOG -->
                <xcad:LayoutAnchorable AutoHideMinHeight="200" ContentId="BuildLog" Title="{Binding Debugging.OutputTitle, Source={x:Static gs:GameStudioViewModel.GameStudio}}"
                                       gs:AvalonDockHelper.IsVisible="{Binding Panels.BuildLogPanelVisible, Mode=TwoWay,
                                       Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                  <TabControl x:Name="LogTabControl">
                    <TabItem DataContext="{Binding Debugging.BuildLog}">
                      <TabItem.Header>
                        <TextBlock FontWeight="{Binding HasNewMessages, Mode=OneWay, Converter={xk:BoolToParam},
                                    ConverterParameter={x:Static FontWeights.Bold}, FallbackValue={x:Static FontWeights.Normal}}">
                                    <Run Text="{xk:Localize Build}"/>
                                    <Run Text="{Binding HasNewMessages, Mode=OneWay, Converter={xk:BoolToParam}, ConverterParameter=*}"/>
                        </TextBlock>
                      </TabItem.Header>
                      <xk:TextLogViewer LogMessages="{Binding Messages}" ShowDebugMessages="False" ShowVerboseMessages="False" ShowInfoMessages="True"/>
                      <i:Interaction.Behaviors>
                        <xk:TabItemActivateOnLogBehavior MinimumLevel="Error" Collection="{Binding Messages}"/>
                      </i:Interaction.Behaviors>
                    </TabItem>
                    <!-- FIXME live scripting is disabled (XK-4309) -->
                    <TabItem DataContext="{Binding Debugging.LiveScriptingLog}" Visibility="Collapsed">
                      <TabItem.Header>
                        <TextBlock FontWeight="{Binding HasNewMessages, Mode=OneWay, Converter={xk:BoolToParam},
                                    ConverterParameter={x:Static FontWeights.Bold}, FallbackValue={x:Static FontWeights.Normal}}">
                                    <Run Text="{xk:Localize Live-scripting}"/>
                                    <Run Text="{Binding HasNewMessages, Mode=OneWay, Converter={xk:BoolToParam}, ConverterParameter=*}"/>
                        </TextBlock>
                      </TabItem.Header>
                      <xk:TextLogViewer LogMessages="{Binding Messages}" ShowDebugMessages="False" ShowVerboseMessages="False" ShowInfoMessages="True"/>
                      <i:Interaction.Behaviors>
                        <xk:TabItemActivateOnLogBehavior MinimumLevel="Error" Collection="{Binding Messages}"/>
                      </i:Interaction.Behaviors>
                    </TabItem>
                    <i:Interaction.Behaviors>
                      <xk:OnEventCommandBehavior Command="{Binding SelectedItem.DataContext.ClearNewMessageFlagCommand, ElementName=LogTabControl}" EventName="SelectionChanged"/>
                    </i:Interaction.Behaviors>
                  </TabControl>
                  <i:Interaction.Behaviors>
                    <xk:OnEventCommandBehavior Command="{Binding Debugging.ResetOutputTitleCommand}" EventName="IsActiveChanged"/>
                    <gs:LayoutAnchorableActivateOnLogBehavior MinimumLevel="Error" Collection="{Binding Debugging.BuildLog.Messages}"/>
                    <gs:LayoutAnchorableActivateOnLogBehavior MinimumLevel="Error" Collection="{Binding Debugging.LiveScriptingLog.Messages}"/>
                  </i:Interaction.Behaviors>
                </xcad:LayoutAnchorable>
              </xcad:LayoutAnchorablePane>
            </xcad:LayoutPanel>
            <xcad:LayoutAnchorablePaneGroup Orientation="Vertical" DockWidth="400">
              <xcad:LayoutAnchorablePane DockHeight="2*">
                <!-- PROPERTY GRID -->
                <xcad:LayoutAnchorable AutoHideMinWidth="400" ContentId="PropertyGrid" Title="{Binding Source={xk:Localize Property grid, Context=View}}"
                                       gs:AvalonDockHelper.IsVisible="{Binding Panels.PropertyGridPanelVisible, Mode=TwoWay,
                                       Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                  <Grid Background="{StaticResource ToolBarBackgroundBrush}">
                    <Grid.RowDefinitions>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="*"/>
                      <RowDefinition Height="5"/>
                      <RowDefinition Height="70"/>
                    </Grid.RowDefinitions>
                    <DockPanel Margin="6,6,6,2">
                      <!-- Adding tag -->
                      <xk:TextBox MinWidth="90" DockPanel.Dock="Right" ValidateOnLostFocus="False" WatermarkContent="{xk:Localize Add new tag}" x:Name="NewTagTextBox"  Visibility="{Binding Session.ActiveAssetView.SelectedAssets.Count, Converter={xk:Chained {xk:NumericToBool}, {xk:VisibleOrCollapsed}}}">
                        <i:Interaction.Behaviors>
                          <xk:OnEventCommandBehavior EventName="Validated" Command="{Binding Session.AssetTags.AddTagCommand}" CommandParameter="{Binding Text, ElementName=NewTagTextBox}"/>
                          <xk:OnEventCommandBehavior EventName="Validated" Command="{x:Static xk:TextBox.ClearTextCommand}"/>
                        </i:Interaction.Behaviors>
                      </xk:TextBox>
                      <!-- Navigation -->
                      <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Margin="0,0,6,0" VerticalAlignment="Center">
                        <Button Content="{xk:Image {StaticResource ImagePrevious}, 16, 16, HighQuality}" Style="{StaticResource {x:Static ToolBar.ButtonStyleKey}}"
                            Command="{Binding Session.PreviousSelectionCommand}"
                            ToolTip="{xk:Localize Previous selection, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Session.Editor.Status}" ToolTipService.ShowOnDisabled="True" />
                        <Button Content="{xk:Image {StaticResource ImageNext}, 16, 16, HighQuality}" Style="{StaticResource {x:Static ToolBar.ButtonStyleKey}}"
                            Command="{Binding Session.NextSelectionCommand}"
                            ToolTip="{xk:Localize Next selection, Context=ToolTip}" xk:ToolTipHelper.Status="{Binding Session.Editor.Status}" ToolTipService.ShowOnDisabled="True" />
                      </StackPanel>
                      <!-- Description -->
                      <TextBlock TextTrimming="CharacterEllipsis" VerticalAlignment="Center">
                        <Run Text="{Binding Session.ActiveProperties.TypeDescription, Mode=OneWay}" FontWeight="Bold"/>
                        <Run Text="{Binding Session.ActiveProperties.Name, Mode=OneWay}"/>
                      </TextBlock>
                    </DockPanel>
                    <!--  TAGS  -->
                    <ToolBar Grid.Row="1" Margin="6,2" ItemsSource="{Binding Session.AssetTags.Tags}" HorizontalAlignment="Stretch" Visibility="{Binding Session.AssetTags.Tags.Count, Converter={xk:Chained {xk:NumericToBool}, {xk:VisibleOrCollapsed}}}"
                             Style="{StaticResource TagToolBarStyle}">
                      <ToolBar.ItemTemplate>
                        <DataTemplate>
                          <xk:TagControl Height="20" Margin="2" ToolTip="{Binding Name}" Visibility="{Binding Assets.Count, Converter={xk:Chained {xk:NumericToBool}, {xk:VisibleOrCollapsed}}}"
                                       VerticalAlignment="Center" CloseTagCommand="{Binding RemoveTagCommand}">
                            <StackPanel Orientation="Horizontal">
                              <TextBlock Margin="2,0" Text="{Binding Name}" TextTrimming="CharacterEllipsis" MaxWidth="100" VerticalAlignment="Center" />
                              <TextBlock Text="{Binding Counter}" Cursor="Hand" IsEnabled="{Binding Counter, Converter={xk:Chained {xk:StringEquals}, {xk:InvertBool}, Parameter1={} (all)}}"
                                         ToolTip="{xk:Localize Add tag to all, Context=ToolTip}">
                            <i:Interaction.Behaviors>
                              <xk:OnEventCommandBehavior EventName="MouseDown" Command="{Binding AddTagToAllCommand}"/>
                            </i:Interaction.Behaviors>
                              </TextBlock>
                            </StackPanel>
                          </xk:TagControl>
                        </DataTemplate>
                      </ToolBar.ItemTemplate>
                    </ToolBar>

                    <DockPanel Grid.Row="3" Margin="6,2">
                      <Button Command="{Binding Session.EditSelectedContentCommand}" DockPanel.Dock="Top" HorizontalContentAlignment="Center" Margin="0,0,0,8"
                              Visibility="{Binding Session.EditSelectedContentCommand.IsEnabled, Converter={xk:VisibleOrCollapsed}, FallbackValue={xk:Collapsed}}">
                        <Grid>
                          <DockPanel Visibility="{Binding Session.ActiveProperties.CanDisplayProperties, Converter={xk:VisibleOrCollapsed}}">
                            <Image Source="{StaticResource ImageEditAsset}" Margin="4" DockPanel.Dock="Left" Width="24" Height="24" RenderOptions.BitmapScalingMode="NearestNeighbor"/>
                            <TextBlock Text="{xk:Localize Open this asset in editor}" Margin="0,4,4,4" VerticalAlignment="Center" />
                          </DockPanel>
                          <TextBlock Text="{xk:Localize Show this asset in editor}" Margin="0,4,4,4" VerticalAlignment="Center"
                                     Visibility="{Binding Session.ActiveProperties.CanDisplayProperties, Converter={xk:Chained {xk:InvertBool}, {xk:VisibleOrCollapsed}}}" />
                        </Grid>
                      </Button>
                      <DockPanel Visibility="{Binding Session.ActiveProperties.CanDisplayProperties, Converter={xk:VisibleOrCollapsed}}">
                        <!-- TODO: Disabling this button for now, it is relatively terrible in term of UX -->
                        <ToggleButton Margin="4,0" Height="22" Width="22" Content="{xk:Image {StaticResource ImageAssetOverride}, 16, 16}"
                                      IsChecked="{Binding Session.ActiveProperties.ShowOverridesOnly}" ToolTip="{xk:Localize Display only overridden properties, Context=ToolTip}"
                                      Visibility="Collapsed"/>
                        <AdornerDecorator>
                          <xk:TextBox UseTimedValidation="True" x:Name="PropertyFilterTextBox" WatermarkContent="{xk:Localize Search properties}">
                            <i:Interaction.Behaviors>
                              <xk:ContainTextAdornerBehavior />
                            </i:Interaction.Behaviors>
                          </xk:TextBox>
                        </AdornerDecorator>
                      </DockPanel>
                    </DockPanel>

                    <TextBlock Grid.Row="4" Text="{Binding Session.ActiveProperties.FallbackMessage}" HorizontalAlignment="Center" VerticalAlignment="Center"
                           Visibility="{Binding Session.ActiveProperties.CanDisplayProperties, Converter={xk:Chained {xk:InvertBool}, {xk:VisibleOrCollapsed}}}"/>
                    <xk:PropertyView x:Name="AssetPropertyView" Grid.Row="4"
                                       ItemsSource="{Binding Session.ActiveProperties.ViewModel.RootNode.Children}"
                                       Visibility="{Binding Session.ActiveProperties.CanDisplayProperties, Converter={xk:VisibleOrCollapsed}}">
                      <xk:PropertyView.Resources>
                        <SolidColorBrush x:Key="ItemHoverBrush" Color="#FF525252" />
                        <RoutedUICommand x:Key="ReplaceCommand" Text="Replace">
                          <RoutedUICommand.InputGestures>
                            <KeyGesture>Ctrl+Shift+V</KeyGesture>
                          </RoutedUICommand.InputGestures>
                        </RoutedUICommand>
                      </xk:PropertyView.Resources>
                      <xk:PropertyView.ItemContainerStyle>
                        <Style BasedOn="{StaticResource {x:Type xk:PropertyViewItem}}" TargetType="xk:PropertyViewItem">
                          <Setter Property="Background" Value="Transparent"/>
                          <Setter Property="ContextMenu">
                            <Setter.Value>
                              <ContextMenu Visibility="{Binding HasItems, RelativeSource={RelativeSource Self}, Converter={xk:VisibleOrHidden}, FallbackValue={xk:Hidden}}">
                                <MenuItem Header="{xk:Localize Reset to base value, Context=Menu}" Command="{Binding ResetOverride, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"
                                          IsEnabled="{Binding HasBase}"/>
                                <Separator />
                                <MenuItem Icon="{xk:Image {StaticResource ImageCopy}}"
                                          Command="ApplicationCommands.Copy" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type MenuBase}}}"/>
                                <MenuItem Icon="{xk:Image {StaticResource ImagePaste}}"
                                          Command="ApplicationCommands.Paste" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type MenuBase}}}" />
                                <MenuItem Icon="{xk:Image {StaticResource ImagePaste}}"
                                          Visibility="{Binding HasCommand_ReplaceProperty, Converter={xk:VisibleOrCollapsed}, FallbackValue={xk:Collapsed}}"
                                          Command="{StaticResource ReplaceCommand}" CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType={x:Type MenuBase}}}"/>
                              </ContextMenu>
                            </Setter.Value>
                          </Setter>
                          <Setter Property="HeaderTemplate">
                            <Setter.Value>
                              <HierarchicalDataTemplate ItemsSource="{Binding Children, Mode=OneWay}" DataType="viewModels:NodeViewModel">
                                <ContentPresenter Content="{Binding}" ContentTemplateSelector="{x:Static xk:PropertyViewHelper.HeaderProviders}"/>
                              </HierarchicalDataTemplate>
                            </Setter.Value>
                          </Setter>
                          <Setter Property="Template">
                            <Setter.Value>
                              <ControlTemplate TargetType="xk:PropertyViewItem">
                                <Border BorderThickness="{TemplateBinding Border.BorderThickness}" BorderBrush="{TemplateBinding Border.BorderBrush}" SnapsToDevicePixels="True"
                                        Visibility="{Binding IsVisible, Converter={xk:VisibleOrCollapsed}}" d:DataContext="{d:DesignInstance viewModels:NodeViewModel}">
                                  <DockPanel>
                                    <Border DockPanel.Dock="Top" Background="{TemplateBinding Background}">
                                      <ContentPresenter ContentSource="Header" Name="PART_Header"
                                                        Content="{TemplateBinding HeaderedContentControl.Header}"
                                                        ContentTemplate="{TemplateBinding HeaderTemplate}"
                                                        ContentTemplateSelector="{TemplateBinding HeaderTemplateSelector}"
                                                        ContentStringFormat="{TemplateBinding HeaderedItemsControl.HeaderStringFormat}"
                                                        HorizontalAlignment="{TemplateBinding Control.HorizontalContentAlignment}"
                                                        SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}"
                                                        Visibility="{xk:MultiBinding {Binding DataContext.Session.ActiveProperties.ShowOverridesOnly, Converter={xk:InvertBool}, RelativeSource={RelativeSource AncestorType=xk:PropertyView}},
                                                                                       {Binding IsOverridden},
                                                                                       {Binding HasBase, Converter={xk:InvertBool}},
                                                                                       Converter={xk:MultiChained {xk:OrMultiConverter}, {xk:VisibleOrCollapsed}}}"/>
                                    </Border>
                                    <Expander x:Name="propertyExpander" IsExpanded="{TemplateBinding IsExpanded}" Style="{StaticResource PropertyExpanderStyle}" IsEnabled="True">
                                      <StackPanel>
                                        <ItemsPresenter Name="ItemsHost"/>
                                        <Border Background="{TemplateBinding Background}">
                                          <ContentPresenter Name="PART_Footer"
                                                            Content="{TemplateBinding HeaderedContentControl.Header}"
                                                            ContentTemplateSelector="{x:Static xk:PropertyViewHelper.FooterProviders}"
                                                            HorizontalAlignment="{TemplateBinding Control.HorizontalContentAlignment}"
                                                            SnapsToDevicePixels="{TemplateBinding UIElement.SnapsToDevicePixels}"
                                                            Visibility="{xk:MultiBinding {Binding DataContext.Session.ActiveProperties.ShowOverridesOnly, Converter={xk:InvertBool}, RelativeSource={RelativeSource AncestorType=xk:PropertyView}},
                                                                                           {Binding IsOverridden},
                                                                                           {Binding HasBase, Converter={xk:InvertBool}},
                                                                                           Converter={xk:MultiChained {xk:OrMultiConverter}, {xk:VisibleOrCollapsed}}}"/>
                                        </Border>
                                      </StackPanel>
                                    </Expander>
                                  </DockPanel>
                                </Border>
                              </ControlTemplate>
                            </Setter.Value>
                          </Setter>
                          <Setter Property="xk:Interaction.Behaviors">
                            <Setter.Value>
                              <xk:BehaviorCollection>
                                <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Copy" ContinueRouting="False" Command="{Binding CopyProperty, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                                <xk:CommandBindingBehavior RoutedCommand="ApplicationCommands.Paste" ContinueRouting="False" Command="{Binding PasteProperty, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}"/>
                                <xk:CommandBindingBehavior RoutedCommand="{StaticResource ReplaceCommand}" ContinueRouting="False" Command="{Binding ReplaceProperty, FallbackValue={x:Static xk:DisabledCommand.Instance}, Mode=OneWay}" />
                                <xk:PropertyViewFilteringBehavior FilterToken="{Binding Text, ElementName=PropertyFilterTextBox, Mode=OneWay}"/>
                                <xk:PropertyViewItemDragDropBehavior CanDrop="False" CanDrag="False" CanInsert="True"/>
                              </xk:BehaviorCollection>
                            </Setter.Value>
                          </Setter>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding Documentation, FallbackValue={x:Null}}" Value="{x:Null}">
                              <Setter Property="Highlightable" Value="False"/>
                            </DataTrigger>
                            <Trigger Property="IsHovered" Value="True">
                              <Setter Property="Background" Value="{StaticResource ItemHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsFocused" Value="True">
                              <Setter Property="Background" Value="{StaticResource NormalBrush}"/>
                            </Trigger>
                            <Trigger Property="IsKeyboardActive" Value="True">
                              <Setter Property="Background" Value="{StaticResource NormalBrush}"/>
                            </Trigger>
                          </Style.Triggers>
                          <Style.Resources>
                            <Style TargetType="{x:Type xk:TextBox}" BasedOn="{StaticResource {x:Type xk:TextBox}}">
                              <Setter Property="ToolTip" Value="{Binding Text, RelativeSource={RelativeSource Self}}" />
                              <Setter Property="ToolTipService.IsEnabled" Value="{Binding Text, RelativeSource={RelativeSource Self}, Converter={xk:Chained {xk:EmptyStringToBool}, {xk:InvertBool}, Parameter1={xk:True}}}" />
                            </Style>
                          </Style.Resources>
                        </Style>
                      </xk:PropertyView.ItemContainerStyle>
                      <i:Interaction.Behaviors>
                        <xk:PropertyViewDragDropBehavior Target="{Binding Session.ActiveProperties.ViewModel}" CanDrag="False" CanDrop="True" CanInsert="False" />
                        <xk:PropertyViewFilteringBehavior FilterToken="{Binding Text, ElementName=PropertyFilterTextBox, Mode=OneWay}"/>
                        <xk:PropertyViewAutoExpandNodesBehavior ViewModel="{Binding Session.ActiveProperties.ViewModel, Mode=OneWay}"/>
                      </i:Interaction.Behaviors>
                    </xk:PropertyView>

                    <GridSplitter Grid.Row="5" HorizontalAlignment="Stretch" Height="5" ResizeBehavior="PreviousAndNext"/>

                    <Border Grid.Row="6" Background="{StaticResource ToolBarBackgroundBrush}">
                      <DockPanel>
                        <TextBlock Margin="4" DockPanel.Dock="Top" FontWeight="Bold" Text="{Binding HoveredItem.DataContext.DisplayName, ElementName=AssetPropertyView}" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Margin="4" Text="{Binding HoveredItem.DataContext.Documentation, ElementName=AssetPropertyView}" TextWrapping="Wrap" TextTrimming="WordEllipsis"/>
                      </DockPanel>
                    </Border>
                  </Grid>
                </xcad:LayoutAnchorable>
              </xcad:LayoutAnchorablePane>
              <xcad:LayoutAnchorablePaneGroup DockHeight="1*">
                <xcad:LayoutAnchorablePane>
                  <!-- ASSET PREVIEW -->
                  <xcad:LayoutAnchorable AutoHideMinWidth="400" ContentId="AssetPreview" Title="{Binding Source={xk:Localize Asset preview, Context=View}}"
                                         gs:AvalonDockHelper.IsVisible="{Binding Panels.AssetPreviewPanelVisible, Mode=TwoWay,
                                         Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                    <DockPanel LastChildFill="True">
                      <ContentPresenter Content="{Binding Preview.PreviewObject}"/>
                    </DockPanel>
                  </xcad:LayoutAnchorable>
                  <!-- ACTION HISTORY -->
                  <xcad:LayoutAnchorable AutoHideMinWidth="400" ContentId="ActionHistory" Title="{Binding Source={xk:Localize Edit history, Context=View}}"
                                         gs:AvalonDockHelper.IsVisible="{Binding Panels.ActionHistoryPanelVisible, Mode=TwoWay,
                                         Source={x:Static gs:GameStudioViewModel.GameStudio}, FallbackValue={xk:True}}">
                    <ListBox ItemsSource="{Binding Session.ActionHistory.Transactions}" HorizontalContentAlignment="Stretch">
                      <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                          <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        </Style>
                      </ListBox.ItemContainerStyle>
                      <ListBox.ItemTemplate>
                        <DataTemplate>
                          <DockPanel HorizontalAlignment="Stretch">
                            <TextBlock DockPanel.Dock="Left" x:Name="txt" Text="{Binding Name, Mode=OneWay}"/>
                            <Image DockPanel.Dock="Right" x:Name="img" Source="{StaticResource ImageSave}" HorizontalAlignment="Right" Visibility="Hidden"/>
                          </DockPanel>
                          <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsDone, Mode=OneWay}" Value="False">
                              <Setter TargetName="txt" Property="Foreground" Value="{DynamicResource PressedBrush}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsSavePoint, Mode=OneWay}" Value="True">
                              <Setter TargetName="img" Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                          </DataTemplate.Triggers>
                        </DataTemplate>
                      </ListBox.ItemTemplate>
                    </ListBox>
                  </xcad:LayoutAnchorable>
                </xcad:LayoutAnchorablePane>
              </xcad:LayoutAnchorablePaneGroup>
            </xcad:LayoutAnchorablePaneGroup>
          </xcad:LayoutPanel>
        </xcad:LayoutRoot>
      </xcad:DockingManager>
      <StatusBar Grid.Row="2" Background="#007ACC" Visibility="{Binding Session, Converter={xk:Chained {xk:ObjectToBool}, {xk:VisibleOrCollapsed}}}">
        <StatusBar.ItemsPanel>
          <ItemsPanelTemplate>
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="100"/>
              </Grid.ColumnDefinitions>
            </Grid>
          </ItemsPanelTemplate>
        </StatusBar.ItemsPanel>
        <StatusBarItem Grid.Column="0" Content="{Binding Status.CurrentStatus}"/>
        <Separator Grid.Column="1"/>
        <StatusBarItem Grid.Column="2">
          <TextBlock>
            <Run Text="{xk:Localize {}{0} item, Plural={}{0} items, Count={Binding Session.ActiveAssetView.FilteredContent.Count, Mode=OneWay}, IsStringFormat=True, Context=StatusBar}"/>
            <Run Text="{xk:Localize ({0} selected), Plural=({0} selected), Count={Binding Session.ActiveAssetView.SelectedContent.Count, Mode=OneWay}, IsStringFormat=True, Context=StatusBar}"/>
          </TextBlock>
        </StatusBarItem>
        <Separator Grid.Column="3"/>
        <StatusBarItem Grid.Column="4" HorizontalContentAlignment="Right">
          <TextBlock Margin="5,0" Text="{Binding Status.CurrentJob.Message}"/>
        </StatusBarItem>
        <StatusBarItem Grid.Column="5" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch">
          <ProgressBar Visibility="{Binding Status.CurrentJob, Converter={xk:Chained {xk:ObjectToBool}, {xk:VisibleOrCollapsed}}}"
                       IsIndeterminate="{Binding Status.CurrentJob.IsIndeterminate}" Maximum="{Binding Status.CurrentJob.Total}"
                       Value="{Binding Status.CurrentJob.Current}">
          </ProgressBar>
        </StatusBarItem>
      </StatusBar>
    </Grid>
  </Grid>
</Window>

