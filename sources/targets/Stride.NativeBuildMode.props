<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    Stride Native Build Mode Configuration
    
    Manages which toolchain is used for native C++ compilation and linking.
    
    Build Modes:
    - Clang (default):   Uses clang for compilation and LLVM LLD for linking
                        Works on Windows, Linux, macOS, iOS, Android
                        RECOMMENDED: Cross-platform, no MSVC dependency
    
    - Msvc:              Uses clang for compilation and MSVC linker for linking (Windows only)
                        Requires Visual Studio or MSVC toolset
                        LEGACY: For projects that need MSVC-specific behavior
    
    - Legacy:            Deprecated alias for Msvc, will be removed
    
    Usage:
    1. Command line:
       dotnet build /p:StrideNativeBuildMode=Clang
    
    2. Environment variable:
       set StrideNativeBuildMode=Clang
    
    3. In .csproj/.props file:
       <StrideNativeBuildMode>Clang</StrideNativeBuildMode>
    
    4. User configuration file:
       %APPDATA%\Stride\Stride.Build.props or similar
  -->

  <PropertyGroup>
    <!-- Default to MSVC mode to not disturb existing builds and CI/CD -->
    <StrideNativeBuildMode Condition="'$(StrideNativeBuildMode)' == ''">Msvc</StrideNativeBuildMode>
    
    <!-- Validate build mode is one of the supported values -->
    <_ValidBuildModes>Clang;Msvc;Legacy</_ValidBuildModes>
  </PropertyGroup>

  <!-- Set boolean flags for each build mode -->
  <PropertyGroup>
    <StrideNativeBuildModeClang Condition="'$(StrideNativeBuildMode)' == 'Clang'">true</StrideNativeBuildModeClang>
    <StrideNativeBuildModeClang Condition="'$(StrideNativeBuildMode)' != 'Clang'">false</StrideNativeBuildModeClang>
    
    <StrideNativeBuildModeMsvc Condition="'$(StrideNativeBuildMode)' == 'Msvc'">true</StrideNativeBuildModeMsvc>
    <StrideNativeBuildModeMsvc Condition="'$(StrideNativeBuildMode)' != 'Msvc'">false</StrideNativeBuildModeMsvc>
    
    <!-- Legacy is treated as Msvc -->
    <StrideNativeBuildModeLegacy Condition="'$(StrideNativeBuildMode)' == 'Legacy'">true</StrideNativeBuildModeLegacy>
    <StrideNativeBuildModeLegacy Condition="'$(StrideNativeBuildMode)' != 'Legacy'">false</StrideNativeBuildModeLegacy>
    
    <!-- If Legacy, use Msvc mode -->
    <StrideNativeBuildMode Condition="'$(StrideNativeBuildMode)' == 'Legacy'">Msvc</StrideNativeBuildMode>
  </PropertyGroup>

  <!-- Diagnostic target to inform user of build mode -->
  <Target Name="_StrideNativeBuildModeInfo" BeforeTargets="Build" Condition="'$(StrideNativeOutputName)' != ''">
    <Message Text="[Stride] Native build mode: $(StrideNativeBuildMode)" Importance="normal" />
    <Message Text="[Stride] To use Clang+LLD: dotnet build /p:StrideNativeBuildMode=Clang" Importance="low" />
  </Target>

  <!-- Help target -->
  <Target Name="StrideNativeBuildModeHelp">
    <Message Text="" Importance="high" />
    <Message Text="======================================" Importance="high" />
    <Message Text="Stride Native Build Modes" Importance="high" />
    <Message Text="======================================" Importance="high" />
    <Message Text="" Importance="high" />
    <Message Text="Msvc (default, Windows only):" Importance="high" />
    <Message Text="  - Uses clang for compilation, MSVC linker for linking" Importance="high" />
    <Message Text="  - Requires Visual Studio or MSVC toolset" Importance="high" />
    <Message Text="  - DEFAULT mode (preserves existing behavior)" Importance="high" />
    <Message Text="  - Requires: vcxproj infrastructure" Importance="high" />
    <Message Text="" Importance="high" />
    <Message Text="Clang (new option, cross-platform):" Importance="high" />
    <Message Text="  - Uses clang for compilation, LLVM LLD for linking" Importance="high" />
    <Message Text="  - Works on all platforms: Windows, Linux, macOS, iOS, Android" Importance="high" />
    <Message Text="  - Does NOT require Visual Studio or MSVC" Importance="high" />
    <Message Text="  - Faster linking, better cross-platform consistency" Importance="high" />
    <Message Text="" Importance="high" />
    <Message Text="Usage Examples:" Importance="high" />
    <Message Text="  dotnet build /p:StrideNativeBuildMode=Clang" Importance="high" />
    <Message Text="  set StrideNativeBuildMode=Clang &amp;&amp; dotnet build" Importance="high" />
    <Message Text="" Importance="high" />
  </Target>

</Project>
